## 角色创建

在Concordia框架中，通过`prefab_lib.InstanceConfig`类来实现对模型的人物设置。以下是详细说明：

### 使用的类和方法

1. **prefab_lib.InstanceConfig 类**
   - 用于配置实例的主要类，定义每个辩论参与者的属性
   - 通过这个类可以指定预制件类型、角色和参数

2. **prefab_lib.Role 枚举**
   - 用于定义实体在模拟中的角色类型
   - 使用 `prefab_lib.Role.ENTITY` 表示这是一个实体角色

3. **自定义的 DebateAdvocate 类**
   - 从 prefab_lib.Prefab 继承的自定义类
   - 专门用于创建具有特定辩论能力的代理

### 参数详解

在 `prefab_lib.InstanceConfig` 中，包含以下关键参数：

- **prefab**：指定使用的预制件类型，在例子中使用的是 `"debate_advocate__Entity"`，这是我们自定义的辩论代理

- **role**：指定实体的角色类型，使用 `prefab_lib.Role.ENTITY` 表示这是一个普通实体

- **params 参数字典**包含以下具体参数：
  - **name**：角色的名称，如 "Qwen支持者"
  - **position**：辩论立场，"pro" 表示正方，"con" 表示反方
  - **debate_topic**：辩论主题，如 "可再生能源优于核能来应对气候变化"
  - **goal**：角色的目标，描述该角色试图证明什么
  - **traits**：角色特征，描述角色的辩论风格和个性特点
  - **model_key**：关联的语言模型标识符，用于指定使用哪个具体的AI模型

### 示例代码

```python
prefab_lib.InstanceConfig(
    prefab="debate_advocate__Entity",
    role=prefab_lib.Role.ENTITY,
    params={
        "name": "Qwen支持者",
        "position": "pro",
        "debate_topic": "可再生能源优于核能来应对气候变化",
        "goal": "用数据和事实支持可再生能源优先",
        "traits": "强势、逻辑严密、直击对方弱点",
        "model_key": "qwen"
    },
),
```

### 参数如何传递到LLM

人物设置参数通过以下步骤传递到LLM中：

1. **参数定义与注册**：
   - 在 `create_debate_config()` 函数中定义 `InstanceConfig` 对象
   - 参数存储在 `params` 字典中，包括角色名称、立场、辩论主题等
   - 自定义的 `DebateAdvocate` 类被注册到预制件系统中

2. **数据流向**：
   - `InstanceConfig` 对象被收集到 `instances` 列表中
   - 该列表作为配置的一部分传递给 `prefab_lib.Config`
   - 最终通过 `simulation.Simulation` 构造函数传递给模拟环境

3. **代理构建过程**：
   - 当模拟启动时，系统调用 `DebateAdvocate.build()` 方法
   - 在此方法中，通过 `self.params.get()` 提取所有角色参数
   - 这些参数用于构建代理的行为指令和特性

4. **LLM接收参数的方式**：
   - **模型选择**：通过 `model_key` 参数从 `MODEL_REGISTRY` 中获取对应的LLM实例
   - **行为指令**：将所有角色参数整合成详细的指令文本，指导LLM如何表现
   - **组件配置**：创建记忆、观察、指令等组件，它们都使用指定的LLM模型
   - **动作生成**：当代理需要行动时，系统按顺序调用各组件并将结果合并后发送给LLM

5. **具体实现细节**：
   ```python
   # 在DebateAdvocate.build()方法中
   name = self.params.get("name", "Debater")
   position = self.params.get("position", "pro")
   debate_topic = self.params.get("debate_topic", "")
   goal = self.params.get("goal", "")
   traits = self.params.get("traits", "")
   model_key = self.params.get("model_key", None)

   # 构建行为指令
   instructions_text = (
       f"您正在参加一场正式辩论。"
       f"主题：{debate_topic}。"
       f"您的既定立场为：{stance_text}。"
       f"目标：{goal}。风格：{traits}。"
       # ... 更多指令
   )

   # 创建使用指定模型的组件
   similar_memories = agent_components.all_similar_memories.AllSimilarMemories(
       model=MODEL_REGISTRY.get(model_key) if model_key and MODEL_REGISTRY.get(model_key) else model,
       # ...
   )
   ```

通过这种方式，我们可以为每个AI模型创建具有特定角色、立场和个性的虚拟辩论者，使辩论更加生动和有针对性。
